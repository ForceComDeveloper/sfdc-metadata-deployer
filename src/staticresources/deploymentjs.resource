jQuery.noConflict(),jQuery(function(){var e=new Deployment,r=jQuery.getUrlVar("access_token"),t=jQuery.getUrlVar("instance_url");if(r&&t){var n=JSON.parse(decodeURIComponent(jQuery.getUrlVar("state")));localStorage.setItem(n.prefix,JSON.stringify({accessToken:decodeURIComponent(r),instanceUrl:decodeURIComponent(t)})),jQuery("#"+n.prefix+"-prod").prop("checked","login"===n.env);var o={env:n.env};"retrieve"===n.prefix?e.retrievePackage(o).then(HandleRetrieve.success)["catch"](HandleRetrieve.error):"deploy"===n.prefix&&e.deployPackage(o).then(HandleDeploy.success)["catch"](HandleDeploy.error)}jQuery("#retrieve-prod").change(function(){OAuthHelper.resetConn("retrieve")}),jQuery("#retrieve-reset").click(function(){OAuthHelper.resetConn("retrieve")}),jQuery("#deploy-prod").change(function(){OAuthHelper.resetConn("deploy")}),jQuery("#deploy-reset").click(function(){OAuthHelper.resetConn("deploy")}),jQuery(".deploy").on("drop",function(r){if(r.originalEvent.dataTransfer&&r.originalEvent.dataTransfer.files.length){var t=r.originalEvent.dataTransfer.files[0],n=new Promise(function(e,r){var n=new FileReader;n.onerror=r,n.onload=e,n.readAsBinaryString(t)});r.preventDefault(),r.stopPropagation(),n.then(function(t,n){sessionStorage.setItem("zip",Base64String.compress(btoa(r.target.result)));var o={};o.testLevel=jQuery(".radio :checked").val(),o.rollbackOnError=jQuery("#rollback").is(":checked"),o.checkOnly=jQuery("#check").is(":checked"),o.env=jQuery("#deploy-prod").is(":checked")?"login":"test",e.deployPackage(o).then(HandleDeploy.success)["catch"](HandleDeploy.error)})}return jQuery(this).removeClass("drop"),!1}),jQuery(".retrieve").on("drop",function(r){if(r.originalEvent.dataTransfer&&r.originalEvent.dataTransfer.files.length){r.preventDefault(),r.stopPropagation();var t=r.originalEvent.dataTransfer.files[0];e.retrievePackage({file:t,env:jQuery("#deploy-prod").is(":checked")?"login":"test"}).then(HandleRetrieve.success)["catch"](HandleRetrieve.error)}return jQuery(this).removeClass("drop"),!1}),jQuery(".drop-zone").on("dragover",function(e){e.preventDefault(),e.stopPropagation(),jQuery(this).addClass("drop")}),jQuery(".drop-zone").on("dragleave",function(e){e.preventDefault(),e.stopPropagation(),jQuery(this).removeClass("drop")})});var ConnectionHelper=function(){};ConnectionHelper.prototype=function(){var e=function(e){var r=localStorage.getItem(e.prefix);if(r){r=JSON.parse(r);var t=new jsforce.Connection({instanceUrl:r.instanceUrl,accessToken:r.accessToken,proxyUrl:"/services/proxy"});return t.metadata.pollTimeout=3e6,t}window.open("https://"+e.env+".salesforce.com/services/oauth2/authorize?response_type=token&client_id="+encodeURIComponent(ConnectedAppConfig.clientId)+"&redirect_uri="+encodeURIComponent(ConnectedAppConfig.redirectUri)+"&scope=api&prompt=login%20consent&state="+encodeURIComponent(JSON.stringify(e)),"_self")},r=function(e){localStorage.removeItem(e)};return{getConn:e,resetConn:r}}();var OAuthHelper=new ConnectionHelper,Deployment=function(){this._tests=[]};Deployment.prototype=function(){var e=function(e){var r=this;return new Promise(function(t,n){Papa.parsePromise(e.file).then(function(n){var o={};o.types=[],o.version="34.0",r._tests=[];var a=o.types;n.data.shift(),n.data.forEach(function(e){if(e[0]||e[1]){var t,n=e[0],o=e[1],s=a.filter(function(e){return e.name===n});0===s.length?(t={},t.members=[],t.name=n,a.push(t)):t=s[0],o&&-1===t.members.indexOf(o)&&(t.members.push(o),o=o.toLowerCase(),"ApexClass"===n&&o.indexOf("test")>-1&&r._tests.push(o))}}),e["package"]=o,sessionStorage.setItem("retrieve-options",JSON.stringify(e)),t(e)})["catch"](n)})},r=function(e){var r=this;return new Promise(function(t,n){var o=new Promise(function(r,t){var n=new FileReader;n.onerror=t,n.onload=r,n.readAsText(e.file)});o.then().then(function(o){var a=o.target.result;try{a=a.replace('<?xml version="1.0" encoding="UTF-8"?>',"");var s=getPropertyCaseInsensitive(jQuery.xml2json(a),"package");if(delete s.$,s.types.constructor!==Array){var i=s.types;s.types=[],s.types.push(i)}s.types.forEach(function(e){delete e.$,"object"!=typeof e.members&&(e.members=[e.members]),"ApexClass"===e.name&&e.members.forEach(function(e){e=e.toLowerCase(),e.indexOf("test")>-1&&r._tests.push(e)})}),e["package"]=s,sessionStorage.setItem("retrieve-options",JSON.stringify(e)),t(e)}catch(o){n(htmlSpecialChars(""+o))}})["catch"](n)})},t=function(t){return new Promise(function(n,a){if(optionsFromLocalStorage=JSON.parse(sessionStorage.getItem("retrieve-options")),optionsFromLocalStorage&&optionsFromLocalStorage["package"])return o(optionsFromLocalStorage).then(n)["catch"](a);if(!t.file)return a("No file selected");var s,i=t.file.name.split(".").pop();"csv"===i?s=e:"xml"===i?s=r:a("File type not supported"),s(t).then(o).then(n)["catch"](a)})},n=function(e){return new Promise(function(r,t){var n=OAuthHelper.getConn({prefix:"deploy",env:e.env});n||r("Authent in progress"),delete e.env,n.metadata.deploy(Base64String.decompress(sessionStorage.getItem("zip")),e).complete(!0,function(e,n){return sessionStorage.removeItem("zip"),localStorage.removeItem("deploy"),e?t(e):void r(n)})})},o=function(e){return e["package"]||(e["package"]=JSON.parse(sessionStorage.getItem("package"))),new Promise(function(r,t){var n=OAuthHelper.getConn({prefix:"retrieve",env:e.env});n||r("Authent in progress"),n.metadata.retrieve({unpackaged:e["package"]}).complete(function(n,o){if(sessionStorage.removeItem("package"),localStorage.removeItem("retrieve"),n)return t(n);var a=document.createElement("a");a.href="data:application/zip;base64,"+o.zipFile,a.download=(new Date).toLocaleString()+".zip",a.click(),r(e["package"])})})};return{retrievePackage:t,deployPackage:n}}();var HandleRetrieve={success:function(e){jQuery(".retrieve-message").append('<pre class="alert-success">'+JSON.stringify(e,null,2)+"</pre>").show(500)},error:function(e){jQuery(".retrieve-message").append('<p class="alert-error">'+JSON.stringify(e,null,2)+"</p>").show(500)}},HandleDeploy={success:function(e){jQuery(".deploy-message").append('<pre class="alert-success">'+JSON.stringify(e,null,2)+"</pre>").show(500)},error:function(e){jQuery(".deploy-message").append('<p class="alert-error">'+JSON.stringify(e,null,2)+"</p>").show(500)}};Papa.parsePromise=function(e){return new Promise(function(r,t){Papa.parse(e,{complete:r,error:t})})};var getPropertyCaseInsensitive=function(e,r){if("object"==typeof e)for(var t in e)if(e.hasOwnProperty(t)&&t.toLowerCase()===r.toLowerCase())return e[t];return""},htmlSpecialChars=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};jQuery.extend({getUrlVars:function(){var e=[],r=window.location.href.slice(window.location.href.indexOf("#")+1).split("&");return r.forEach(function(r){var t=r.split("=");e.push(t[0]),e[t[0]]=t[1]}),e},getUrlVar:function(e){return jQuery.getUrlVars()[e]}});