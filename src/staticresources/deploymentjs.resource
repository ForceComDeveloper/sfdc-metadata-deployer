jQuery.noConflict(),jQuery(function(){var e,t,r=jQuery.getUrlVar("access_token"),n=jQuery.getUrlVar("instance_url"),o=jQuery.getUrlVar("state");if(window.history.pushState(null,"Salesforce Metadata Deployment","/apex/deployment"),"undefined"!=typeof r&&"undefined"!=typeof n)if("undefined"==typeof o)e=new Oauth2Settings(decodeURIComponent(n),decodeURIComponent(r));else{t=new Oauth2Settings(decodeURIComponent(n),decodeURIComponent(r));var o=JSON.parse(decodeURIComponent(o));e=new Oauth2Settings(o.instanceUrl,o.accessToken)}if(e)if(t){var a=new Deployment(e,t);jQuery("#fileToUpload").change(function(){var e=jQuery(this),t=e.val().replace(/\\/g,"/").replace(/.*\//,""),r=e.parents(".input-group").find(":text");r.val(t),a.createPackage(e.prop("files")[0]),this.value=null}),jQuery("#retrieve-button").click(function(){a.retrievePackage()}),jQuery("#deploy-button").click(function(){var e={};e.testLevel=jQuery(".radio :checked").val(),e.rollbackOnError=jQuery("#rollback").is(":checked"),e.checkOnly=jQuery("#check").is(":checked"),a.deployPackage(e)}),jQuery(".drop-zone").on("dragenter",function(){return jQuery(this).css("border","3px dashed #BBBBBB"),!1}),jQuery(".drop-zone").on("dragover",function(e){return e.preventDefault(),e.stopPropagation(),jQuery(this).css("border","3px dashed #BBBBBB"),!1}),jQuery(".drop-zone").on("dragleave",function(e){return e.preventDefault(),e.stopPropagation(),jQuery(this).css("border",""),!1}),jQuery("#deploy").on("drop",function(e){if(e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length){e.preventDefault(),e.stopPropagation();var t=e.originalEvent.dataTransfer.files[0],r=new FileReader;r.onload=function(){a._zipContent=btoa(e.target.result);var t={};t.testLevel=jQuery(".radio :checked").val(),t.rollbackOnError=jQuery("#rollback").is(":checked"),t.checkOnly=jQuery("#check").is(":checked"),a.deployPackage(t)},r.readAsBinaryString(t)}return jQuery(this).css("border",""),!1}),jQuery("#upload").on("drop",function(e){return e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length&&(e.preventDefault(),e.stopPropagation(),a.createPackage(e.originalEvent.dataTransfer.files[0])),jQuery(this).css("border",""),!1}),jQuery(".process-form").show(500)}else{var i="https://"+(jQuery("#deploy-prod").is(":checked")?"login":"test")+".salesforce.com/services/oauth2/authorize?response_type=token&client_id="+Oauth2AppConfig.clientId+"&redirect_uri="+Oauth2AppConfig.redirectUri+"&prompt=login&display=popup&state="+encodeURIComponent(JSON.stringify(e));jQuery("#deploy-setup-button").click(function(){window.open(i,"_self")}),jQuery(".deploy-setup").show(500)}else jQuery("#retrieve-setup-button").click(function(){var e="https://"+(jQuery("#retrieve-prod").is(":checked")?"login":"test")+".salesforce.com/services/oauth2/authorize?response_type=token&client_id="+Oauth2AppConfig.clientId+"&redirect_uri="+Oauth2AppConfig.redirectUri+"&prompt=login&display=popup";window.open(e,"_self")}),jQuery(".retrieve-setup").show(500)});var Oauth2Settings=function(e,t){this.instanceUrl=e,this.accessToken=t},Deployment=function(e,t){this._package={},this._zipContent={},this._tests=[],this._file,this.retrieveConn=new jsforce.Connection({instanceUrl:e.instanceUrl,accessToken:e.accessToken,proxyUrl:"/services/proxy"}),this.retrieveConn.metadata.pollTimeout=3e5,this.deployConn=new jsforce.Connection({instanceUrl:t.instanceUrl,accessToken:t.accessToken,proxyUrl:"/services/proxy"}),this.deployConn.metadata.pollTimeout=3e5};Deployment.prototype=function(){var e=function(){var e=new FileReader,t=this;e.readAsText(t._file),e.onloadend=function(e){jQuery("#content-upload-info").html("<p>"+e.target.result+"</p>"),jQuery("#content-upload-success").html("<p>File ok</p>"),jQuery("#content-upload-info").show(500)},Papa.parse(t._file,{complete:function(e){t._package={},t._package.types=[],t._package.version="34.0",t._tests=[];var r=t._package.types;e.data.shift(),e.data.forEach(function(e){if(e[0]||e[1]){var n,o=e[0],a=e[1],i=r.filter(function(e){return e.name===o});0===i.length?(n={},n.members=[],n.name=o,r.push(n)):n=i[0],a&&-1===n.members.indexOf(a)&&(n.members.push(a),a=a.toLowerCase(),"ApexClass"===o&&a.indexOf("test")>-1&&t._tests.push(a)),jQuery("#content-retrieve-info").html("<p>"+JSON.stringify(t._package,null,1)+"</p>"),jQuery(".retrieve-process").show(500)}})}})},t=function(){var e=this,t=new FileReader;t.readAsText(e._file),t.onloadend=function(t){var r=t.target.result;jQuery("#content-upload-info").html("<p>"+htmlSpecialChars(r)+"</p>").show(500);try{var n=getPropertyCaseInsensitive(jQuery.xml2json(r),"package");delete n.$,n.types.forEach(function(e){delete e.$,"object"!=typeof e.members&&(e.members=[e.members])}),e._package=n}catch(t){return void jQuery("#error-upload").html("<p>"+htmlSpecialChars(""+t)+"</p>").show(500)}jQuery("#content-upload-success").html("<p>File ok</p>"),jQuery("#content-retrieve-info").html("<p>"+JSON.stringify(e._package,null,1)+"</p>"),jQuery(".retrieve-process").show(500)}},r=function(r){if(jQuery("#error-upload").html(""),!r){var n="No file selected";return void jQuery("#error-upload").html("<p>"+n+"</p>")}this._file=r,"text/csv"===r.type?e.call(this):"text/xml"===r.type&&t.call(this)},n=function(){var e=this;this.retrieveConn.metadata.retrieve({unpackaged:this._package}).complete(function(t,r){if(t)return void jQuery("#error-retrieve").html("<p>"+t+"</p>");var n=document.createElement("a");n.href="data:application/zip;base64,"+r.zipFile,n.download=(new Date).toLocaleString()+".zip",n.click(),e._zipContent=r.zipFile,jQuery("#content-retrieve-success").html("<p>Statut : "+r.status+"</p>"),jQuery(".deployment-process").show(500)})},o=function(e){var t=this;"RunSpecifiedTests"===e.testLevel&&(e.runTests=this._tests),this.deployConn.metadata.deploy(t._zipContent,e).complete(function(e,r){return e?void jQuery("#error-deploy").html("<p>"+e+"</p>"):(jQuery("#content-deploy-success").html("<p>"+r.status+"</p>"),jQuery("#content-deploy-info").html("<p>done ? :"+r.done+", \nsuccess ? : "+r.true+", \nstate : "+r.state+", \ncomponent errors: "+r.numberComponentErrors+", \ncomponents deployed: "+r.numberComponentsDeployed+", \ntests completed: "+r.numberTestsCompleted+"</p>"),jQuery("#content-deploy-info").show(500),void t.deployConn.metadata.checkDeployStatus(r.id,!0,function(t,r){return e?void jQuery("#error-deploy").html("<p>"+t+"</p>"):void jQuery("#content-deploy-info").append("<p>"+JSON.stringify(r.details,null,1)+"</p>")}))})};return{createPackage:r,retrievePackage:n,deployPackage:o}}();var getPropertyCaseInsensitive=function(e,t){if("object"==typeof e)for(var r in e)if(e.hasOwnProperty(r)&&r.toLowerCase()===t.toLowerCase())return e[r];return""},htmlSpecialChars=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};jQuery.extend({getUrlVars:function(){var e=[],t=window.location.href.slice(window.location.href.indexOf("#")+1).split("&");return t.forEach(function(t){var r=t.split("=");e.push(r[0]),e[r[0]]=r[1]}),e},getUrlVar:function(e){return jQuery.getUrlVars()[e]}});