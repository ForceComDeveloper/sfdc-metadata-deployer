jQuery.noConflict();var retrieve_config,deploy_config;jQuery(function(){var e=jQuery.getUrlVar("access_token"),r=jQuery.getUrlVar("instance_url"),t=jQuery.getUrlVar("state"),s=new Deployment;if("undefined"!=typeof e&&"undefined"!=typeof r&&"undefined"!=typeof t)if(t=JSON.parse(decodeURIComponent(t)),"0"===t.status){retrieve_config=new Oauth2Settings(decodeURIComponent(r),decodeURIComponent(e)),s=new Deployment(retrieve_config,deploy_config);var o=JSON.parse(sessionStorage.getItem("package"));console.log(JSON.stringify(o)),console.log("package"),s.doRetrieve(o)}else if("1"===t.status){deploy_config=new Oauth2Settings(decodeURIComponent(r),decodeURIComponent(e)),retrieve_config=new Oauth2Settings(t.instanceUrl,t.accessToken),s=new Deployment(retrieve_config,deploy_config);var n={};n.testLevel=jQuery(".radio :checked").val(),n.rollbackOnError=jQuery("#rollback").is(":checked"),n.checkOnly=jQuery("#check").is(":checked"),s.deployPackage(n)}jQuery(".deploy").on("drop",function(e){if(sessionStorage.removeItem("package"),e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length){e.preventDefault(),e.stopPropagation();var r=e.originalEvent.dataTransfer.files[0],t=new FileReader;t.onload=function(){sessionStorage.setItem("zip",btoa(e.target.result));var r={};r.testLevel=jQuery(".radio :checked").val(),r.rollbackOnError=jQuery("#rollback").is(":checked"),r.checkOnly=jQuery("#check").is(":checked"),s.deployPackage(r)},t.readAsBinaryString(r)}return jQuery(this).css("border",""),!1}),jQuery(".retrieve").on("drop",function(e){return console.log("dropped"),console.log(e),e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length&&(e.preventDefault(),e.stopPropagation(),s.retrievePackage(e.originalEvent.dataTransfer.files[0])),jQuery(this).css("border",""),!1}),jQuery(".drop-zone").on("dragover",function(e){e.preventDefault(),e.stopPropagation(),jQuery(this).addClass("drop")}),jQuery(".drop-zone").on("dragleave",function(e){e.preventDefault(),e.stopPropagation(),jQuery(this).removeClass("drop")})});var Oauth2Settings=function(e,r){this.instanceUrl=e,this.accessToken=r},Deployment=function(e,r){this._tests=[],this.retrieveConn,this.deployConn,"undefined"!=typeof e&&(this.retrieveConn=new jsforce.Connection({instanceUrl:e.instanceUrl,accessToken:e.accessToken,proxyUrl:"/services/proxy"}),this.retrieveConn.metadata.pollTimeout=3e6),"undefined"!=typeof r&&(this.deployConn=new jsforce.Connection({instanceUrl:r.instanceUrl,accessToken:r.accessToken,proxyUrl:"/services/proxy"}),this.deployConn.metadata.pollTimeout=3e6)};Deployment.prototype=function(){var e=function(e){var r=this;Papa.parse(e,{complete:function(e){var t={};t.types=[],t.version="34.0",r._tests=[];var s=t.types;e.data.shift(),e.data.forEach(function(e){if(e[0]||e[1]){var t,o=e[0],n=e[1],a=s.filter(function(e){return e.name===o});0===a.length?(t={},t.members=[],t.name=o,s.push(t)):t=a[0],n&&-1===t.members.indexOf(n)&&(t.members.push(n),n=n.toLowerCase(),"ApexClass"===o&&n.indexOf("test")>-1&&r._tests.push(n))}}),o.call(r,t)}})},r=function(e){var r=this,t=new FileReader;t.onloadend=function(e){var t=e.target.result;console.log(t);try{if(-1!==t.indexOf("<?xml"))return void jQuery(".retrieve-message").append('<p class="list-group-item list-group-item-error"><span class="badge alert-error pull-right">Error</span>Remove the "<?>" tags</p>').show(500);var s=getPropertyCaseInsensitive(jQuery.xml2json(t),"package");if(delete s.$,console.log(s),s.types.constructor!==Array){var n=s.types;s.types=[],s.types.push(n)}s.types.forEach(function(e){delete e.$,"object"!=typeof e.members&&(e.members=[e.members])}),o.call(r,s)}catch(e){console.log(e),jQuery(".retrieve-message").append('<p class="list-group-item list-group-item-error"><span class="badge alert-error pull-right">Error</span>'+htmlSpecialChars(""+e)+"</p>").show(500)}},t.readAsText(e)},t=function(t){if(!t){var s="No file selected";return void jQuery(".retrieve-message").append('<p class="list-group-item list-group-item-error"><span class="badge alert-error pull-right">Error</span>'+s+"</p>").show(500)}"text/csv"===t.type?e.call(this,t):"text/xml"===t.type&&r.call(this,t)},s=function(e){var r=this;if("undefined"==typeof this.deployConn){var t={status:"1",instanceUrl:retrieve_config.instanceUrl,accessToken:retrieve_config.accessToken},s="https://"+(jQuery("#retrieve-prod").is(":checked")?"login":"test")+".salesforce.com/services/oauth2/authorize?response_type=token&client_id="+Oauth2AppConfig.clientId+"&redirect_uri="+Oauth2AppConfig.redirectUri+"&prompt=login&display=popup&state="+encodeURIComponent(JSON.stringify(t));return void window.open(s,"_self")}"RunSpecifiedTests"===e.testLevel&&(e.runTests=this._tests),this.deployConn.metadata.deploy(sessionStorage.getItem("zip"),e).complete(function(e,t){return e?void jQuery(".deploy-message").append('<p class="list-group-item list-group-item-error"><span class="badge alert-error pull-right">Error</span>'+e+"</p>").show(500):(jQuery(".deploy-message").append('<p class="list-group-item list-group-item-success"><span class="badge alert-success pull-right">Success</span>'+t.status+"</p>").show(500),jQuery("#deploy-info").html("<p>done ? :"+t.done+", \nsuccess ? : "+t["true"]+", \nstate : "+t.state+", \ncomponent errors: "+t.numberComponentErrors+", \ncomponents deployed: "+t.numberComponentsDeployed+", \ntests completed: "+t.numberTestsCompleted+"</p>").show(500),void r.deployConn.metadata.checkDeployStatus(t.id,!0,function(r,t){return e?void jQuery(".deploy-message").append('<p class="list-group-item list-group-item-error"><span class="badge alert-error pull-right">Error</span>'+e+"</p>").show(500):void jQuery("#deploy-info").append("<p>"+JSON.stringify(t.details,null,1)+"</p>")}))})},o=function(e){if("undefined"==typeof this.retrieveConn){sessionStorage.setItem("package",JSON.stringify(e));var r={status:"0"},t="https://"+(jQuery("#retrieve-prod").is(":checked")?"login":"test")+".salesforce.com/services/oauth2/authorize?response_type=token&client_id="+Oauth2AppConfig.clientId+"&redirect_uri="+Oauth2AppConfig.redirectUri+"&prompt=login&display=popup&state="+encodeURIComponent(JSON.stringify(r));return void window.open(t,"_self")}jQuery(".retrieve-message").append('<p class="list-group-item list-group-item-success"><span class="badge alert-success pull-right">Success</span>Package parsed</p>').show(500),jQuery(".retrieve-info").html(JSON.stringify(e,null,1)).show(500),this.retrieveConn.metadata.retrieve({unpackaged:e}).complete(function(e,r){if(e)return void jQuery(".retrieve-message").append('<p class="list-group-item list-group-item-error"><span class="badge alert-error pull-right">Error</span>'+e+"</p>").show(500);var t=document.createElement("a");t.href="data:application/zip;base64,"+r.zipFile,t.download=(new Date).toLocaleString()+".zip",t.click(),jQuery(".retrieve-message").append('<p class="list-group-item list-group-item-success"><span class="badge alert-success pull-right">Success</span>'+r.status+"</p>").show(500)})};return{retrievePackage:t,deployPackage:s,doRetrieve:o}}();var getPropertyCaseInsensitive=function(e,r){if("object"==typeof e)for(var t in e)if(e.hasOwnProperty(t)&&t.toLowerCase()===r.toLowerCase())return e[t];return""},htmlSpecialChars=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};jQuery.extend({getUrlVars:function(){var e=[],r=window.location.href.slice(window.location.href.indexOf("#")+1).split("&");return r.forEach(function(r){var t=r.split("=");e.push(t[0]),e[t[0]]=t[1]}),e},getUrlVar:function(e){return jQuery.getUrlVars()[e]}});